on:
  workflow_call:
  workflow_dispatch:
  pull_request:
    paths:
      - installer.sh
      - action.ts
      - action.yml
      - .github/workflows/ci.yml

concurrency:
  group: ${{ github.ref || 'ci' }}/0
  cancel-in-progress: true

jobs:
  linuxen:
    continue-on-error: true
    runs-on: ubuntu-latest
    strategy:
      matrix:
        container:
          - debian:buster-slim
          - debian:bullseye-slim
          - debian:bookworm-slim
          - archlinux:latest
          # - ubuntu:bionic    glibc too old
          - ubuntu:focal
          - ubuntu:jammy
          - ubuntu:kinetic
          # - ubuntu:lunar     glibc too old
          # - ubuntu:trusty
          # - ubuntu:xenial     glibc too old
          - fedora:latest
          # - nixos/nix:latest  can’t exec
          # - alpine:latest     tea binary doesn’t actually end up on the system (wtf)
        mechanism:
          - installer
          - action
    container: ${{ matrix.container }}
    steps:
      - run: echo x $BASH_VERSION$ZSH_VERSION x
      - run: echo x${BASH_VERSION}x${ZSH_VERSION}x

      - uses: actions/checkout@v3

      - uses: ./
        if: ${{ matrix.mechanism == 'action' }}

      - run: apt-get update && apt-get --yes install curl
        if: ${{ (startsWith(matrix.container, 'debian') || startsWith(matrix.container, 'ubuntu')) && matrix.mechanism == 'installer' }}

      - run: ./installer.sh
        if: ${{ matrix.mechanism == 'installer' }}

      - run: tea node --eval 'console.log(1)'

  multiple-apply-is-ok:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: ./
      - run: tea --version
      - uses: ./
      - run: tea --version
      - run: ./installer.sh
      - run: ./installer.sh
