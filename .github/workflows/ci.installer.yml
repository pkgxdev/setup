on:
  workflow_call:
  pull_request:
    paths:
      - installer.sh
      - .github/workflows/ci.installer.yml

concurrency:
  group: ${{ github.ref || 'ci' }}/installer.sh
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  install-tea:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os:
          - macos-latest
          - ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - run: ./installer.sh
      - run: tea --version

  usage-as-proxy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - run: ./installer.sh node --eval 'console.log(1)'
      - run: ./installer.sh sh -c "which tea"
      - run: if command -v tea; then exit 1; fi

  sudo-not-required:
    runs-on: ubuntu-latest
    container: debian:buster-slim
    steps:
      - uses: actions/checkout@v3
      - run: ./installer.sh
        env:
          PATH: ${{ github.workspace }}/bin:/usr/bin:/bin

  eval:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - run: |
          eval "$(cat ./installer.sh)"
          tea +duf
          duf --version

          test -n "$BASH_VERSION"
          test -z "$ZSH_VERSION"
        shell: bash -e {0}

      # verify the pkgenv is reset each step
      - run:
          if duf; then exit; fi

      # check tea was installed despite executing via `eval`
      - run:
          tea duf --version

      - run: |
          eval "$(cat ./installer.sh)"
          tea +duf
          duf --version

          test -n "$ZSH_VERSION"
          test -z "$BASH_VERSION"
        shell: zsh -e {0}

      - run: |
          eval "$(cat ./installer.sh)"
          tea +duf
          duf --version

          test -z "$ZSH_VERSION"
          test -z "$BASH_VERSION"
        shell: /bin/sh -e {0}

  sudo-required:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - run: sudo chmod go-w /usr/local/bin
      # ^^ we run as `runner` but this dir has 999 perms
      - run: ./installer.sh
      - run: test "$(which tea)" = /usr/local/bin/tea

  no-dirs:
    strategy:
      matrix:
        dir: [/usr/local, /usr/local/bin]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - run: sudo mv ${{ matrix.dir }} $(mktemp -d)
      - run: ./installer.sh
      - run: tea duf --version
